# Роль-ориентированные отчеты

## Обзор

Система отчетов теперь поддерживает роль-ориентированный доступ, который автоматически фильтрует данные в зависимости от роли пользователя.

## Реализованные возможности

### 1. Middleware для проверки доступа (`middleware/roleAccess.js`)

**RoleAccessManager** предоставляет следующие функции:

- `checkReportAccess(userRole, reportType)` - проверяет доступ к типу отчета
- `getDataFilters(user)` - возвращает фильтры для SQL запросов
- `requireReportAccess(allowedRoles)` - middleware для Express маршрутов
- `getUserSpecificData(user, db)` - получает статистику для конкретного пользователя

### 2. Роли и их права доступа

| Роль | Доступные отчеты | Фильтрация данных |
|------|------------------|-------------------|
| **Администратор** | Все отчеты + системные метрики | Полный доступ ко всем данным |
| **Менеджер** | Общие, оборудование, статусы, мастерские, продукты | Полный доступ ко всем данным |
| **Менеджер по качеству** | Общие, оборудование, статусы, мастерские, продукты | Полный доступ ко всем данным |
| **Специалист** | Личная статистика + статистика по специалистам | Только заявки, назначенные на данного специалиста |
| **Заказчик** | Личная статистика | Только собственные заявки |
| **Оператор** | Общие, оборудование, статусы | Полный доступ к заявкам |

### 3. Обновленный StatisticsService

Все методы расчета статистики теперь принимают необязательный параметр `filters`:

```javascript
calculateGeneralStatistics(filters = null)
calculateEquipmentStatistics(filters = null)
calculateStatusStatistics(filters = null)
calculateWorkshopStatistics(filters = null)
```

### 4. Обработка ошибок доступа

При попытке доступа к отчетам без прав пользователь получает информативное сообщение:

- **401** - Требуется авторизация
- **403** - Доступ запрещен с указанием роли пользователя

## Примеры использования

### Для Заказчика (login7 / pass7)
- Видит только свои заявки
- Статистика показывает: "Всего моих заявок"
- Информационное сообщение о фильтрации данных

### Для Специалиста (login2 / pass2)
- Видит только заявки, назначенные на него
- Дополнительно видит свою статистику работ
- Статистика показывает: "Всего моих работ"

### Для Менеджера (login1 / pass1)
- Полный доступ ко всем отчетам
- Видит статистику по всем специалистам
- Может экспортировать полные отчеты в PDF

## Технические детали

### Структура фильтров

```javascript
{
  type: 'client' | 'master' | 'full' | 'none',
  userId: number | null,
  whereClause: string,
  params: array
}
```

### SQL запросы с фильтрацией

Пример для клиента:
```sql
SELECT COUNT(*) as count 
FROM repair_requests r 
WHERE r.client_id = ?
```

Пример для специалиста:
```sql
SELECT COUNT(*) as count 
FROM repair_requests r 
WHERE r.master_id = ?
```

## Безопасность

- Все маршруты защищены middleware `requireAuth`
- Дополнительная проверка через `RoleAccessManager.requireReportAccess()`
- SQL инъекции предотвращены использованием параметризованных запросов
- Фильтры применяются на уровне базы данных, а не на уровне приложения

## Тестирование

Все существующие тесты проходят успешно. Роль-ориентированная фильтрация протестирована для:
- Клиентов (4 заявки)
- Специалистов (2 заявки)
- Менеджеров (полный доступ)

## Будущие улучшения

- Добавить кэширование статистики для повышения производительности
- Реализовать аудит доступа к отчетам
- Добавить возможность экспорта в другие форматы (Excel, CSV)
