<h2>Все заявки</h2>

<% if (requests.length > 0) { %>
<!-- Статистика -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
    <div class="stat-card">
        <h3><%= requests.filter(r => !r.master_name).length %></h3>
        <p>Без специалиста</p>
    </div>
    
    <div class="stat-card">
        <h3><%= requests.filter(r => r.status_id === 5).length %></h3>
        <p>Завершенных</p>
    </div>
    
    <div class="stat-card">
        <h3><%= requests.filter(r => [1, 2, 3].includes(r.status_id)).length %></h3>
        <p>Активных</p>
    </div>
    
    <div class="stat-card">
        <h3><%= requests.length %></h3>
        <p>Показано заявок</p>
    </div>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>Действия</th>
                <th>Специалист</th>
                <th>Статус</th>
                <th>Приоритет</th>
                <th>Проблема</th>
                <th>Оборудование</th>
                <th>Клиент</th>
                <th>Дата создания</th>
                <th>№ заявки</th>
            </tr>
        </thead>
        <tbody>
            <% requests.forEach(request => { %>
            <tr>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <a href="/requests/<%= request.request_id %>" class="btn btn-info btn-sm">
                            Просмотр
                        </a>
                    </div>
                </td>
                <td>
                    <% if (request.master_name) { %>
                        <div style="font-size: 13px;"><%= request.master_name %></div>
                    <% } else { %>
                        <span style="color: #6c757d; font-style: italic;">Не назначен</span>
                    <% } %>
                </td>
                <td>
                    <span class="badge" style="background-color: <%= request.status_color %>;">
                        <%= request.status_name %>
                    </span>
                </td>
                <td>
                    <span class="priority-<%= request.priority_level %>">
                        <%= request.priority_level %>
                    </span>
                </td>
                <td>
                    <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                         title="<%= request.problem_description %>">
                        <%= request.problem_description %>
                    </div>
                </td>
                <td>
                    <div><strong><%= request.type_name %></strong></div>
                    <div style="font-size: 12px; color: #6c757d;"><%= request.model_name %></div>
                </td>
                <td>
                    <div><%= request.client_name %></div>
                    <div style="font-size: 12px; color: #6c757d;"><%= request.client_phone %></div>
                </td>
                <td>
                    <%= new Date(request.start_date).toLocaleDateString('ru-RU') %>
                </td>
                <td>
                    <strong><%= request.request_number %></strong>
                </td>
            </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<div class="toolbar">
    <div>
        <form method="GET" style="display: flex; gap: 10px; align-items: center;">
            <button type="submit" class="btn btn-primary">Найти</button>
            <select name="status" onchange="this.form.submit()">
                <option value="">Все статусы</option>
                <% statuses.forEach(status => { %>
                    <option value="<%= status.status_id %>" <%= selectedStatus == status.status_id ? 'selected' : '' %>>
                        <%= status.status_name %>
                    </option>
                <% }) %>
            </select>
            <input type="text" name="search" value="<%= search %>" placeholder="Поиск по номеру, клиенту..." class="search-box">
        </form>
    </div>
    <div>
        <strong>Всего заявок: <%= requests.length %></strong>
    </div>
</div>

<% } else { %>
<div style="text-align: center; padding: 60px 20px;">
    <div style="font-size: 64px; margin-bottom: 20px; color: #6c757d;">□</div>
    <h3 style="color: #6c757d; margin-bottom: 15px;">Заявки не найдены</h3>
    <p style="color: #6c757d;">Попробуйте изменить параметры поиска или фильтрации</p>
    <a href="/requests" class="btn btn-primary" style="margin-top: 20px;">
        Показать все заявки
    </a>
</div>
<% } %>